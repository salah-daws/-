<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مركز حساباتي وممتلكاتي</title>
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #02081a;
      --card: #020617;
      --card-soft: #02081f;
      --border: rgba(148, 163, 184, 0.35);
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.15);
      --accent2: #06b6d4;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #eab308;
      --radius-lg: 18px;
      --radius-md: 12px;
      --transition-fast: 0.18s ease-out;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #020617 55%);
      color: var(--text);
      direction: rtl;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    header h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header h1 span.logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.25);
    }

    header .subtitle {
      font-size: 0.88rem;
      color: var(--muted);
    }

    .header-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 18px;
    }

    .tab-btn {
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.8);
      color: var(--muted);
      padding: 7px 14px;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), color var(--transition-fast),
        transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .tab-btn span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.6);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.22), rgba(6, 182, 212, 0.18));
      border-color: rgba(94, 234, 212, 0.4);
      color: #f9fafb;
      box-shadow: 0 8px 22px rgba(15, 23, 42, 0.6);
      transform: translateY(-1px);
    }

    .tab-btn.active span.dot { background: #a5f3fc; }

    main { display: block; }

    .tab-content {
      display: none;
      animation: fadeIn 0.22s ease-out;
    }

    .tab-content.active { display: block; }

    .card {
      background:
        radial-gradient(circle at top left, rgba(79, 70, 229, 0.16), transparent 55%),
        radial-gradient(circle at bottom right, rgba(6, 182, 212, 0.16), transparent 50%),
        var(--card);
      border-radius: var(--radius-lg);
      padding: 18px 18px 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.85);
      margin-bottom: 16px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 8px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-pill {
      font-size: 0.72rem;
      background: rgba(15, 118, 110, 0.22);
      color: #a5f3fc;
      padding: 2px 9px;
      border-radius: 999px;
      border: 1px solid rgba(45, 212, 191, 0.35);
    }

    .card-description {
      font-size: 0.82rem;
      color: var(--muted);
    }

    .grid-4 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .stat-card {
      background: radial-gradient(circle at top, rgba(15,23,42,0.6), rgba(2,6,23,0.5));
      border-radius: var(--radius-md);
      padding: 12px 12px 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      position: relative;
      overflow: hidden;
    }

    .stat-label {
      font-size: 0.78rem;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
    }

    .stat-value {
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .stat-value span.currency {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .stat-footnote {
      font-size: 0.74rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .stat-badge {
      position: absolute;
      left: 8px;
      top: 8px;
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
      background: rgba(15, 23, 42, 0.8);
    }

    .stat-card.expense .stat-value { color: var(--danger); }
    .stat-card.income .stat-value { color: var(--success); }
    .stat-card.counts .stat-value { color: #38bdf8; }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px 14px;
      align-items: flex-end;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    label { color: var(--muted); }

    input, select, textarea {
      background: rgba(15, 23, 42, 0.92);
      border-radius: 10px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 7px 9px;
      font-size: 0.86rem;
      color: var(--text);
      outline: none;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(94, 234, 212, 0.8);
      box-shadow: 0 0 0 1px rgba(94, 234, 212, 0.55);
      background: rgba(15, 23, 42, 0.98);
    }

    textarea { resize: vertical; min-height: 56px; }

    .btn-primary,
    .btn-secondary,
    .btn-danger,
    .btn-link,
    .btn-xs {
      font-size: 0.82rem;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 7px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition-fast),
        border-color var(--transition-fast), color var(--transition-fast),
        transform var(--transition-fast), box-shadow var(--transition-fast);
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #f9fafb;
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.8);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 36px rgba(15, 23, 42, 0.95);
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(148, 163, 184, 0.6);
      color: var(--muted);
    }

    .btn-secondary:hover {
      background: rgba(15, 23, 42, 1);
      color: var(--text);
    }

    .btn-danger {
      background: rgba(127, 29, 29, 0.95);
      border-color: rgba(248, 113, 113, 0.9);
      color: #fee2e2;
    }

    .btn-danger:hover { background: rgba(185, 28, 28, 1); }

    .btn-xs {
      padding: 3px 8px;
      font-size: 0.72rem;
      border-radius: 999px;
    }

    .btn-link {
      background: transparent;
      border-color: transparent;
      color: var(--muted);
      padding-inline: 4px;
    }

    .btn-link:hover { color: #e5e7eb; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.8rem;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: rgba(15, 23, 42, 0.9);
    }

    th, td {
      padding: 7px 8px;
      text-align: right;
      border-bottom: 1px solid rgba(30, 41, 59, 0.95);
    }

    th {
      background: rgba(15, 23, 42, 0.95);
      font-weight: 500;
      color: var(--muted);
    }

    tr:nth-child(even) td { background: rgba(15, 23, 42, 0.85); }
    tr:last-child td { border-bottom: none; }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--muted);
    }

    .badge-success {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      background: rgba(21, 128, 61, 0.12);
    }

    .badge-warning {
      border-color: rgba(234, 179, 8, 0.75);
      color: #facc15;
      background: rgba(133, 77, 14, 0.15);
    }

    .badge-muted {
      background: rgba(15, 23, 42, 0.8);
    }

    .badge-danger {
      border-color: rgba(248, 113, 113, 0.85);
      color: #fecaca;
      background: rgba(127, 29, 29, 0.35);
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 1);
      border: 1px solid rgba(51, 65, 85, 0.9);
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width 0.25s ease-out;
    }

    .progress-text {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .section-inline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .pill {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--muted);
    }

    .text-danger { color: var(--danger); }
    .text-success { color: var(--success); }
    .text-muted { color: var(--muted); }

    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .mt-16 { margin-top: 16px; }

    .hidden { display: none; }

    .hidden-file-input { display: none; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .card { padding-inline: 14px; }
      .header-actions {
        width: 100%;
        justify-content: flex-start;
      }
    }
  
    
    /* التصنيفات المالية */
    .categories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .stat-card.category-card {
      cursor: grab;
      user-select: none;
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        border-color var(--transition-fast),
        background var(--transition-fast),
        opacity var(--transition-fast);
    }

    .stat-card.category-card.dragging {
      opacity: 0.6;
      border-style: dashed;
    }

    .stat-card.category-card.category-selected {
      box-shadow:
        0 0 0 1px rgba(94, 234, 212, 0.9),
        0 0 24px rgba(8, 47, 73, 0.9);
    }

    .stat-card.category-card.cat-positive {
      border-color: rgba(34, 197, 94, 0.85);
      background:
        radial-gradient(circle at top left, rgba(34, 197, 94, 0.3), transparent 55%),
        radial-gradient(circle at bottom right, rgba(6, 182, 212, 0.2), transparent 55%),
        rgba(15, 23, 42, 0.95);
    }

    .stat-card.category-card.cat-negative {
      border-color: rgba(248, 113, 113, 0.9);
      background:
        radial-gradient(circle at top left, rgba(248, 113, 113, 0.3), transparent 55%),
        radial-gradient(circle at bottom right, rgba(127, 29, 29, 0.45), transparent 55%),
        rgba(15, 23, 42, 0.95);
    }

    .stat-card.category-card.cat-neutral {
      border-color: rgba(148, 163, 184, 0.7);
    }

    .category-meta {
      font-size: 0.72rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .category-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }

    .category-actions .btn-xs {
      padding-inline: 8px;
    }

    .category-empty {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 8px;
    }

    .category-transactions-wrapper {
      margin-top: 14px;
    }

    .category-filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-end;
      margin-top: 8px;
    }

    .category-filter-row .form-group {
      min-width: 150px;
    }

.summary-row td {
      background: rgba(15, 23, 42, 0.98);
      font-weight: 600;
      border-bottom: 2px solid rgba(148, 163, 184, 0.6);
    }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>
          <span class="logo-dot"></span>
          مركزي الشخصي
        </h1>
        <div class="subtitle">
          لوحة واحدة لمتابعة المال، المهام، الممتلكات، المشاريع، المشتريات، والعملاء.
        </div>
      </div>

      <div class="header-actions">
        <button id="sync-remote-btn" class="btn-ghost">مزامنة الآن</button>
        <button id="import-btn" class="btn-secondary">استيراد</button>
        <button id="export-btn" class="btn-primary">حفظ / تصدير</button>
        <input type="file" id="import-file" accept="application/json" class="hidden-file-input" />
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="dashboard">
        <span class="dot"></span> لوحة التحكم
      </button>
      <button class="tab-btn" data-tab="money">
        <span class="dot"></span> المال
      </button>
      <button class="tab-btn" data-tab="categories">
        <span class="dot"></span> التصنيفات
      </button>
      <button class="tab-btn" data-tab="tasks">
        <span class="dot"></span> المهام
      </button>
      <button class="tab-btn" data-tab="assets">
        <span class="dot"></span> الممتلكات
      </button>
      <button class="tab-btn" data-tab="projects">
        <span class="dot"></span> المشاريع
      </button>
      <button class="tab-btn" data-tab="wishlist">
        <span class="dot"></span> المشتريات المستقبلية
      </button>
      <button class="tab-btn" data-tab="clients">
        <span class="dot"></span> قاعدة بيانات العملاء
      </button>
    </nav>

    <main>
      <!-- لوحة التحكم -->
      <section id="tab-dashboard" class="tab-content active">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              نظرة سريعة
              <span class="card-title-pill">اليوم &amp; هذا الشهر</span>
            </div>
          </div>
          <div class="grid-4">
            <div class="stat-card expense">
              <div class="stat-badge">اليوم</div>
              <div class="stat-label">
                <span>صرف اليوم</span>
              </div>
              <div class="stat-value">
                <span id="today-expense">0.00</span>
                <span class="currency">ر.س</span>
              </div>
              <div class="stat-footnote">إجمالي ما خرج اليوم</div>
            </div>

            <div class="stat-card income">
              <div class="stat-badge">اليوم</div>
              <div class="stat-label">
                <span>دخل اليوم</span>
              </div>
              <div class="stat-value">
                <span id="today-income">0.00</span>
                <span class="currency">ر.س</span>
              </div>
              <div class="stat-footnote">كل ما دخل اليوم</div>
            </div>

            <div class="stat-card expense">
              <div class="stat-badge">الشهر</div>
              <div class="stat-label">
                <span>صرف هذا الشهر</span>
              </div>
              <div class="stat-value">
                <span id="month-expense">0.00</span>
                <span class="currency">ر.س</span>
              </div>
              <div class="stat-footnote">من 1 إلى آخر يوم في الشهر</div>
            </div>

            <div class="stat-card income">
              <div class="stat-badge">الشهر</div>
              <div class="stat-label">
                <span>دخل هذا الشهر</span>
              </div>
              <div class="stat-value">
                <span id="month-income">0.00</span>
                <span class="currency">ر.س</span>
              </div>
              <div class="stat-footnote">كل الإيرادات في الشهر</div>
            </div>
          </div>

          <div class="grid-4 mt-12">
            <div class="stat-card counts">
              <div class="stat-label">
                <span>المهام المفتوحة</span>
              </div>
              <div class="stat-value">
                <span id="tasks-open-count">0</span>
                <span class="currency">/ <span id="tasks-total-count">0</span></span>
              </div>
              <div class="stat-footnote">مهام لم تُنجز بعد</div>
            </div>

            <div class="stat-card counts">
              <div class="stat-label">
                <span>المشاريع النشطة</span>
              </div>
              <div class="stat-value">
                <span id="projects-active-count">0</span>
                <span class="currency">/ <span id="projects-total-count">0</span></span>
              </div>
              <div class="stat-footnote">مشاريع تحت العمل حالياً</div>
            </div>
          </div>
        </div>
      </section>

      <!-- المال -->
      <section id="tab-money" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                إدارة المال
                <span class="card-title-pill">دخل &amp; مصروفات</span>
              </div>
              <div class="card-description">
                سجّل كل عملية (دخل أو صرف) وسيتم تحديث لوحة التحكم تلقائيًا.
              </div>
            </div>
          </div>

          <!-- ملخص المال + الرصيد التقريبي + الاستثمار -->
          <div class="section-inline-header mt-8">
            <div class="card-title" style="font-size:0.9rem;">
              ملخص المال
            </div>
            <div class="pill">
              الرصيد التقريبي الحالي محسوب من العمليات المسجلة.
            </div>
          </div>

          <div class="grid-4 mt-8">
            <div class="stat-card counts">
              <div class="stat-label">
                <span>الرصيد التقريبي الحالي</span>
              </div>
              <div class="stat-value">
                <span id="current-balance">0.00</span>
                <span class="currency">ر.س</span>
              </div>
              <div class="stat-footnote">إجمالي الدخل - إجمالي الصرف</div>
            </div>

            <div class="stat-card expense">
              <div class="stat-label">
                <span>تحويل لليمن (مصاريف أسرة)</span>
              </div>
              <div class="stat-value">
                <span id="yemen-total">0.00</span>
                <span class="currency">ر.س</span>
              </div>
              <div class="stat-footnote">إجمالي التحويلات المصنّفة لليمن</div>
            </div>

            <div class="stat-card expense">
              <div class="stat-label">
                <span>مجموع الاستثمار</span>
              </div>
              <div class="stat-value">
                <span id="invest-total">0.00</span>
                <span class="currency">ر.س</span>
              </div>
              <div class="stat-footnote">المبالغ المصنّفة كـ استثمار</div>
            </div>
          </div>

          <!-- نموذج مختصر للاستثمار / تحويل اليمن -->
          <div class="section-inline-header mt-16">
            <div class="card-title" style="font-size:0.9rem;">
              إضافة عملية استثمار / تحويل
            </div>
            <div class="pill">
              اختصار جاهز للاستثمار وتحويل اليمن (مصاريف أسرة).
            </div>
          </div>

          <form id="investment-form" class="mt-8">
            <div class="form-grid">
              <div class="form-group">
                <label for="inv-date">التاريخ</label>
                <input type="date" id="inv-date" />
              </div>
              <div class="form-group">
                <label for="inv-type">النوع</label>
                <select id="inv-type">
                  <option value="yemen">تحويل لليمن (مصاريف أسرة)</option>
                  <option value="invest">استثمار</option>
                </select>
              </div>
              <div class="form-group">
                <label for="inv-amount">المبلغ (ر.س)</label>
                <input type="number" id="inv-amount" step="0.01" min="0" required />
              </div>
              <div class="form-group">
                <label for="inv-note">ملاحظة</label>
                <input type="text" id="inv-note" placeholder="مثلاً: اسم الاستثمار أو الأسرة" />
              </div>
              <div class="form-group">
                <button type="submit" class="btn-secondary">
                  + إضافة كـ استثمار/تحويل
                </button>
              </div>
            </div>
          </form>

          <!-- النموذج الأساسي للعمليات -->
          <form id="transaction-form" class="mt-16">
            <div class="form-grid">
              <div class="form-group">
                <label for="tx-date">التاريخ</label>
                <input type="date" id="tx-date" />
              </div>
              <div class="form-group">
                <label for="tx-type">النوع</label>
                <select id="tx-type">
                  <option value="expense">صرف</option>
                  <option value="income">دخل</option>
                </select>
              </div>
              <div class="form-group">
                <label for="tx-amount">المبلغ (ر.س)</label>
                <input type="number" id="tx-amount" step="0.01" min="0" required />
              </div>
              <div class="form-group">
                <label for="tx-category-select">التصنيف</label>
                <select id="tx-category-select">
                  <option value="">بدون تصنيف</option>
                </select>
              </div>
              <div class="form-group">
                <label for="tx-note">ملاحظة</label>
                <input type="text" id="tx-note" placeholder="وصف مختصر" />
              </div>
              <div class="form-group">
                <button type="submit" class="btn-primary">
                  + إضافة عملية
                </button>
              </div>
            </div>
          </form>

          <table id="transactions-table" class="mt-12">
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>النوع</th>
                <th>المبلغ</th>
                <th>التصنيف</th>
                <th>ملاحظة</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <!-- التصنيفات -->
      <section id="tab-categories" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                التصنيفات المالية
                <span class="card-title-pill">تجميع العمليات حسب التصنيف</span>
              </div>
              <div class="card-description">
                أنشئ تصنيفات (مثل المطاعم، الرواتب، المواصلات...) وشاهد صافي الدخل/الصرف لكل تصنيف،
                مع إمكانية ترتيب البطاقات بالسحب والإفلات حسب الأولوية.
              </div>
            </div>
          </div>

          <!-- نموذج إضافة / تعديل تصنيف -->
          <form id="category-form" class="mt-8">
            <input type="hidden" id="category-id" />
            <div class="form-grid">
              <div class="form-group">
                <label for="category-name">اسم التصنيف</label>
                <input
                  type="text"
                  id="category-name"
                  required
                  placeholder="مثلاً: المطاعم، الرواتب، المواصلات..."
                />
              </div>
              <div class="form-group">
                <button type="submit" id="category-submit-btn" class="btn-primary">
                  + إضافة تصنيف
                </button>
              </div>
            </div>
          </form>

          <!-- فلترة بالتاريخ -->
          <form id="category-filter-form" class="category-filter-row mt-12">
            <div class="form-group">
              <label for="category-filter-from">من تاريخ</label>
              <input type="date" id="category-filter-from" />
            </div>
            <div class="form-group">
              <label for="category-filter-to">إلى تاريخ</label>
              <input type="date" id="category-filter-to" />
            </div>
            <div class="form-group">
              <button type="submit" class="btn-secondary btn-xs">
                تطبيق الفلتر على الإحصاءات
              </button>
            </div>
            <div class="pill">
              الفلتر يؤثر على الأرقام في البطاقات وعلى جدول العمليات بالأسفل.
            </div>
          </form>

          <!-- بطاقات التصنيفات -->
          <div id="categories-grid" class="categories-grid mt-8"></div>
          <div id="categories-empty" class="category-empty hidden">
            لا توجد تصنيفات بعد. أضف أول تصنيف من النموذج بالأعلى.
          </div>

          <!-- جدول العمليات الخاصة بالتصنيف المحدد -->
          <div class="category-transactions-wrapper mt-16">
            <div class="section-inline-header">
              <div class="card-title" style="font-size:0.9rem;">
                العمليات الخاصة بالتصنيف المحدد
              </div>
              <div class="pill" id="category-selected-label">
                اختر بطاقة تصنيف من الأعلى لعرض العمليات المرتبطة به.
              </div>
            </div>

            <table id="category-transactions-table" class="mt-8">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>النوع</th>
                  <th>المبلغ</th>
                  <th>ملاحظة</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>


      <!-- المهام -->
      <section id="tab-tasks" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                المهام
                <span class="card-title-pill">شخصية / عمل</span>
              </div>
              <div class="card-description">
                أضف المهام وقم بتحديث حالتها مع الوقت لتعرف ما تم وما تبقّى.
              </div>
            </div>
          </div>

          <form id="task-form">
            <input type="hidden" id="task-id" />
            <div class="form-grid">
              <div class="form-group">
                <label for="task-title">عنوان المهمة</label>
                <input type="text" id="task-title" required placeholder="مثلاً: إنهاء تقرير المشروع" />
              </div>
              <div class="form-group">
                <label for="task-status">الحالة</label>
                <select id="task-status">
                  <option value="todo">لم تبدأ</option>
                  <option value="in-progress">قيد العمل</option>
                  <option value="done">منتهية</option>
                </select>
              </div>
              <div class="form-group">
                <label for="task-date">تاريخ مستهدف</label>
                <input type="date" id="task-date" />
              </div>
              <div class="form-group">
                <label for="task-notes">ملاحظات</label>
                <input type="text" id="task-notes" placeholder="اختياري" />
              </div>
              <div class="form-group">
                <button type="submit" id="task-submit-btn" class="btn-primary">
                  + إضافة مهمة
                </button>
              </div>
            </div>
          </form>

          <table id="tasks-table" class="mt-12">
            <thead>
              <tr>
                <th>المهمة</th>
                <th>الحالة</th>
                <th>تاريخ مستهدف</th>
                <th>ملاحظات</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- الممتلكات -->
      <section id="tab-assets" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                الممتلكات الحالية
                <span class="card-title-pill">معك الآن</span>
              </div>
              <div class="card-description">
                سجّل الأجهزة، الأدوات، أو أي ممتلكات معك، وانقل القديمة إلى الأرشيف بدل الحذف.
              </div>
            </div>
          </div>

          <form id="asset-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="asset-name">اسم / وصف الممتلك</label>
                <input type="text" id="asset-name" required placeholder="مثلاً: لابتوب تجميع، كاميرا، شاشة..." />
              </div>
              <div class="form-group">
                <label for="asset-location">المكان</label>
                <input type="text" id="asset-location" placeholder="البيت، المكتب، السيارة..." />
              </div>
              <div class="form-group">
                <label for="asset-value">قيمة تقديرية (ر.س)</label>
                <input type="number" id="asset-value" step="0.01" min="0" />
              </div>
              <div class="form-group">
                <label for="asset-notes">ملاحظات</label>
                <input type="text" id="asset-notes" placeholder="سيريال، حالة، ملاحظات أخرى" />
              </div>
              <div class="form-group">
                <button type="submit" class="btn-primary">
                  + إضافة ممتلك
                </button>
              </div>
            </div>
          </form>

          <div class="section-inline-header mt-12">
            <div class="card-title" style="font-size:0.9rem;">
              قائمة الممتلكات الحالية
            </div>
            <div class="pill">
              يمكن نقل أي عنصر للأرشيف بدل حذفه.
            </div>
          </div>

          <table id="assets-current-table" class="mt-8">
            <thead>
              <tr>
                <th>الوصف</th>
                <th>المكان</th>
                <th>القيمة</th>
                <th>ملاحظات</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="section-inline-header mt-16">
            <div class="card-title" style="font-size:0.9rem;">
              الأرشيف
            </div>
            <button type="button" id="toggle-archive-btn" class="btn-secondary btn-xs">
              إخفاء / إظهار الأرشيف
            </button>
          </div>

          <div id="archive-wrapper" class="mt-8">
            <table id="assets-archive-table">
              <thead>
                <tr>
                  <th>الوصف</th>
                  <th>المكان السابق</th>
                  <th>القيمة</th>
                  <th>ملاحظات</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- المشاريع -->
      <section id="tab-projects" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                المشاريع
                <span class="card-title-pill">نسبة الإنجاز</span>
              </div>
              <div class="card-description">
                أضف مشاريعك وحدّد نسبة اكتمالها، ويمكنك تعديل البيانات ونسبة الإنجاز في أي وقت.
              </div>
            </div>
          </div>

          <form id="project-form">
            <input type="hidden" id="project-id" />
            <div class="form-grid">
              <div class="form-group">
                <label for="project-name">اسم المشروع</label>
                <input type="text" id="project-name" required placeholder="مثلاً: تطوير موقع الجمعية، تجهيز حملة..." />
              </div>
              <div class="form-group">
                <label for="project-client">تابع لمن؟</label>
                <input type="text" id="project-client" placeholder="عميل، جهة، أو شخص" />
              </div>
              <div class="form-group">
                <label for="project-status">حالة المشروع</label>
                <select id="project-status">
                  <option value="planned">مخطط</option>
                  <option value="in-progress">قيد التنفيذ</option>
                  <option value="on-hold">معلّق</option>
                  <option value="done">مكتمل</option>
                </select>
              </div>
              <div class="form-group">
                <label for="project-progress">نسبة الإنجاز: <span id="project-progress-label">0%</span></label>
                <input type="range" id="project-progress" min="0" max="100" value="0" />
              </div>
              <div class="form-group">
                <label for="project-notes">ملاحظات</label>
                <input type="text" id="project-notes" placeholder="اختياري" />
              </div>
              <div class="form-group">
                <button type="submit" id="project-submit-btn" class="btn-primary">
                  + إضافة مشروع
                </button>
              </div>
            </div>
          </form>

          <table id="projects-table" class="mt-12">
            <thead>
              <tr>
                <th>المشروع</th>
                <th>الجهة / العميل</th>
                <th>الحالة</th>
                <th>الإنجاز</th>
                <th>ملاحظات</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- المشتريات المستقبلية -->
      <section id="tab-wishlist" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                المشتريات المستقبلية
                <span class="card-title-pill">Wishlist</span>
              </div>
              <div class="card-description">
                سجّل الأشياء التي تنوي شراءها مع سعر تقريبي وأولوية.
              </div>
            </div>
          </div>

          <form id="wishlist-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="wish-item">اسم الشيء</label>
                <input type="text" id="wish-item" required placeholder="مثلاً: شاشة 2K، كيس PC، سماعة..." />
              </div>
              <div class="form-group">
                <label for="wish-category">تصنيف</label>
                <input type="text" id="wish-category" placeholder="مثلاً: PC، صوتيات، تصوير..." />
              </div>
              <div class="form-group">
                <label for="wish-price">سعر تقريبي (ر.س)</label>
                <input type="number" id="wish-price" step="0.01" min="0" />
              </div>
              <div class="form-group">
                <label for="wish-priority">الأولوية</label>
                <select id="wish-priority">
                  <option value="low">منخفضة</option>
                  <option value="medium" selected>متوسطة</option>
                  <option value="high">عالية</option>
                </select>
              </div>
              <div class="form-group">
                <label for="wish-date">وقت تقريبي للشراء</label>
                <input type="date" id="wish-date" />
              </div>
              <div class="form-group">
                <label for="wish-notes">ملاحظات</label>
                <input type="text" id="wish-notes" placeholder="مثلاً: انتظر تخفيض، كود خصم..." />
              </div>
              <div class="form-group">
                <button type="submit" class="btn-primary">
                  + إضافة عنصر
                </button>
              </div>
            </div>
          </form>

          <table id="wishlist-table" class="mt-12">
            <thead>
              <tr>
                <th>العنصر</th>
                <th>التصنيف</th>
                <th>السعر التقريبي</th>
                <th>الأولوية</th>
                <th>الوقت المتوقع</th>
                <th>ملاحظات</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <!-- قاعدة بيانات العملاء -->
      <section id="tab-clients" class="tab-content">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                قاعدة بيانات العملاء
                <span class="card-title-pill">أعمالك</span>
              </div>
              <div class="card-description">
                جدول بسيط لبيانات العملاء: الاسم، الرقم، الشركة / الجهة، ونوع العمل الذي نفذته لهم.
              </div>
            </div>
          </div>

          <form id="client-form">
            <div class="form-grid">
              <div class="form-group">
                <label for="client-name">اسم العميل</label>
                <input type="text" id="client-name" required />
              </div>
              <div class="form-group">
                <label for="client-phone">رقم التواصل</label>
                <input type="tel" id="client-phone" placeholder="05XXXXXXXX" />
              </div>
              <div class="form-group">
                <label for="client-company">الشركة / الجهة</label>
                <input type="text" id="client-company" placeholder="مثلاً: جمعية، شركة، فرد..." />
              </div>
              <div class="form-group">
                <label for="client-work">نوع العمل المنفذ</label>
                <input type="text" id="client-work" placeholder="تصميم، حملة إعلامية، موقع، استشارة..." />
              </div>
              <div class="form-group">
                <label for="client-notes">ملاحظات</label>
                <input type="text" id="client-notes" placeholder="اختياري" />
              </div>
              <div class="form-group">
                <button type="submit" class="btn-primary">
                  + إضافة عميل
                </button>
              </div>
            </div>
          </form>

          <table id="clients-table" class="mt-12">
            <thead>
              <tr>
                <th>العميل</th>
                <th>رقم التواصل</th>
                <th>الشركة / الجهة</th>
                <th>نوع العمل</th>
                <th>ملاحظات</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    const STORAGE_KEY = "personalHubData_v1";

    const REMOTE_DB_URL = "https://script.google.com/macros/s/AKfycbwnhut3afjh6vrk7I_j2IICaJJ1dblAfN4uZlnoksMCJTP9tEdSpD1Xb-PNcbJesYf5/exec";

    let state = {
      transactions: [],
      tasks: [],
      assets: [],
      projects: [],
      futurePurchases: [],
      clients: [],
      categories: []
    };

    
    function loadState() {
      // أولاً: تحميل النسخة المحلية المحفوظة في المتصفح (كـ نسخة احتياطية / تشغيل أوّلي)
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
        }
      } catch (e) {
        console.error("Error loading state", e);
      }

      // ثانياً: محاولة جلب الحالة الأحدث من قاعدة البيانات الأونلاين (Google Sheets)
      // في حال نجاحها تُعتَمد تمامًا كمرجع أساسي
      if (REMOTE_DB_URL) {
        syncFromRemote(false);
      }
    }

    function syncFromRemote(showAlert) {
      if (!REMOTE_DB_URL) {
        if (showAlert) {
          alert("لم يتم ضبط رابط قاعدة البيانات الأونلاين.");
        }
        return;
      }

      try {
        fetch(REMOTE_DB_URL)
          .then(function (res) {
            return res.json();
          })
          .then(function (data) {
            if (
              data &&
              data.state &&
              typeof data.state === "object" &&
              Object.keys(data.state).length > 0
            ) {
              // نستخدم applyImportedData لأنها تحفظ وتعيد رسم الواجهة
              applyImportedData(data.state, showAlert);
            } else if (showAlert) {
              alert("لا توجد بيانات محفوظة في قاعدة البيانات الأونلاين بعد.");
            }
          })
          .catch(function (err) {
            console.error("Remote load error", err);
            if (showAlert) {
              alert("حدث خطأ أثناء الاتصال بقاعدة البيانات الأونلاين.");
            }
          });
      } catch (err) {
        console.error("Remote fetch error (syncFromRemote)", err);
        if (showAlert) {
          alert("حدث خطأ أثناء الاتصال بقاعدة البيانات الأونلاين.");
        }
      }
    }

    function saveState() {
      // حفظ محلي في المتصفح كنسخة احتياطية
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }

      // حفظ في قاعدة البيانات الأونلاين (Google Sheets) إن وُجد رابط
      if (!REMOTE_DB_URL) return;

      try {
        fetch(REMOTE_DB_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          // نخزن كائن state مباشرة في الخلية A2
          body: JSON.stringify(state)
        }).catch(function (err) {
          console.error("Remote save error", err);
        });
      } catch (err) {
        console.error("Remote fetch error (saveState)", err);
      }
    }

    function exportToFile() {
      try {
        const dataStr = JSON.stringify(state, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        const stamp = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = "personal-hub-" + stamp + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error("Export error", e);
        alert("حدث خطأ أثناء التصدير.");
      }
    }

    function applyImportedData(data, showAlert) {
      state = {
        transactions: data.transactions || [],
        tasks: data.tasks || [],
        assets: data.assets || [],
        projects: data.projects || [],
        futurePurchases: data.futurePurchases || [],
        clients: data.clients || [],
        categories: data.categories || []
      };
      saveState();
      renderTransactions();
      renderTasks();
      renderAssets();
      renderProjects();
      renderWishlist();
      renderClients();
      setupCategories();
      renderDashboard();
      if (showAlert) {
        alert("تم استيراد البيانات بنجاح.");
      }
    }

    // تكامل مع ملف قاعدة البيانات باستخدام File System Access API
    const DB_HANDLE_KEY = "personalHubDbHandle_v1";
    const DB_FS_DB_NAME = "personalHubFS_DB";
    const DB_FS_STORE_NAME = "handles";
    let dbFileHandle = null;

    function supportsFileSystemAccess() {
      return (
        "showOpenFilePicker" in window &&
        "indexedDB" in window &&
        typeof indexedDB !== "undefined"
      );
    }

    function openHandlesDb() {
      return new Promise(function (resolve, reject) {
        if (!supportsFileSystemAccess()) {
          resolve(null);
          return;
        }
        const request = indexedDB.open(DB_FS_DB_NAME, 1);
        request.onupgradeneeded = function (event) {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(DB_FS_STORE_NAME)) {
            db.createObjectStore(DB_FS_STORE_NAME);
          }
        };
        request.onsuccess = function () {
          resolve(request.result);
        };
        request.onerror = function () {
          console.error("indexedDB error:", request.error);
          resolve(null);
        };
      });
    }

    async function saveDbFileHandle(handle) {
      try {
        const db = await openHandlesDb();
        if (!db) return;
        await new Promise(function (resolve, reject) {
          const tx = db.transaction(DB_FS_STORE_NAME, "readwrite");
          const store = tx.objectStore(DB_FS_STORE_NAME);
          store.put(handle, DB_HANDLE_KEY);
          tx.oncomplete = function () {
            resolve();
          };
          tx.onerror = function () {
            console.error("Error saving handle:", tx.error);
            resolve();
          };
        });
        db.close();
      } catch (e) {
        console.error("Failed to save DB handle", e);
      }
    }

    async function loadDbFileHandle() {
      try {
        const db = await openHandlesDb();
        if (!db) return null;
        const handle = await new Promise(function (resolve, reject) {
          const tx = db.transaction(DB_FS_STORE_NAME, "readonly");
          const store = tx.objectStore(DB_FS_STORE_NAME);
          const req = store.get(DB_HANDLE_KEY);
          req.onsuccess = function () {
            resolve(req.result || null);
          };
          req.onerror = function () {
            console.error("Error loading handle:", req.error);
            resolve(null);
          };
        });
        db.close();
        return handle || null;
      } catch (e) {
        console.error("Failed to load DB handle", e);
        return null;
      }
    }

    async function askUserForDbFile() {
      if (!supportsFileSystemAccess()) {
        alert("المتصفح لا يدعم الربط المباشر بملف قاعدة البيانات؛ سيتم استخدام التصدير والاستيراد العادي.");
        return null;
      }
      try {
        const pickerOpts = {
          multiple: false,
          types: [
            {
              description: "ملف بيانات JSON",
              accept: { "application/json": [".json"] }
            }
          ]
        };
        const handles = await window.showOpenFilePicker(pickerOpts);
        if (!handles || !handles.length) return null;
        const handle = handles[0];
        dbFileHandle = handle;
        await saveDbFileHandle(handle);
        return handle;
      } catch (e) {
        if (e && e.name === "AbortError") {
          // المستخدم أغلق النافذة
          return null;
        }
        console.error("Error choosing DB file:", e);
        alert("تعذر اختيار ملف قاعدة البيانات.");
        return null;
      }
    }

    async function ensureDbFileHandle() {
      if (dbFileHandle) return dbFileHandle;
      const saved = await loadDbFileHandle();
      if (saved) {
        dbFileHandle = saved;
        return saved;
      }
      // أول مرة: نسأل المستخدم
      return await askUserForDbFile();
    }

    async function importFromDbFile() {
      try {
        const handle = await ensureDbFileHandle();
        if (!handle) return;

        const permission = await handle.queryPermission({ mode: "read" });
        if (permission === "denied") {
          const reqPerm = await handle.requestPermission({ mode: "read" });
          if (reqPerm !== "granted") {
            alert("لا يوجد تصريح لقراءة ملف قاعدة البيانات.");
            return;
          }
        }

        const file = await handle.getFile();
        const text = await file.text();
        const data = JSON.parse(text);
        applyImportedData(data, true);
      } catch (e) {
        console.error("Auto import from DB file failed:", e);
        alert("تعذر قراءة ملف قاعدة البيانات.");
      }
    }

    async function exportToDbFile() {
      try {
        const handle = await ensureDbFileHandle();
        if (!handle) {
          // المستخدم لم يختر ملفاً؛ نرجع للتصدير العادي
          exportToFile();
          return;
        }

        const permission = await handle.queryPermission({ mode: "readwrite" });
        if (permission === "denied") {
          const reqPerm = await handle.requestPermission({ mode: "readwrite" });
          if (reqPerm !== "granted") {
            alert("لا يوجد تصريح لكتابة ملف قاعدة البيانات.");
            return;
          }
        }

        const writable = await handle.createWritable();
        const dataStr = JSON.stringify(state, null, 2);
        await writable.write(dataStr);
        await writable.close();
        alert("تم حفظ البيانات في ملف قاعدة البيانات.");
      } catch (e) {
        console.error("Export to DB file failed:", e);
        alert("تعذر الحفظ في ملف قاعدة البيانات؛ سيتم استخدام طريقة التصدير العادية.");
        exportToFile();
      }
    }

    async function tryAutoImportFromDbFileOnLoad() {
      // إذا كانت قاعدة البيانات الأونلاين مفعلة، لا نستورد تلقائياً من الملف
      if (REMOTE_DB_URL) return;
      if (!supportsFileSystemAccess()) return;
      try {
        const savedHandle = await loadDbFileHandle();
        if (!savedHandle) return;
        dbFileHandle = savedHandle;
        const permission = await savedHandle.queryPermission({ mode: "read" });
        if (permission === "denied") {
          // لا نطالب المستخدم تلقائياً بالصلاحية عند الفتح؛ نتركها لزر الاستيراد
          return;
        }
        const file = await savedHandle.getFile();
        const text = await file.text();
        const data = JSON.parse(text);
        applyImportedData(data, false);
      } catch (e) {
        console.error("Auto-load DB file on startup failed:", e);
      }
    }


    function importFromFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          applyImportedData(data, true);
        } catch (err) {
          console.error("Import error", err);
          alert("ملف غير صالح أو به خطأ.");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function generateId() {
      return (
        Date.now().toString(36) + Math.random().toString(36).substring(2, 7)
      );
    }

    function formatCurrency(num) {
      const n = Number(num) || 0;
      return n.toFixed(2);
    }

    function formatDateStr(d) {
      if (!d) return "-";
      return d;
    }

    function computeCurrentBalance() {
      return state.transactions.reduce((sum, tx) => {
        const amount = Number(tx.amount) || 0;
        if (tx.type === "income") return sum + amount;
        if (tx.type === "expense") return sum - amount;
        return sum;
      }, 0);
    }

    function updateMoneySummary() {
      const balanceEl = document.getElementById("current-balance");
      const yemenEl = document.getElementById("yemen-total");
      const investEl = document.getElementById("invest-total");
      if (!balanceEl || !yemenEl || !investEl) return;

      const balance = computeCurrentBalance();
      let yemenTotal = 0;
      let investTotal = 0;

      state.transactions.forEach((tx) => {
        const amount = Number(tx.amount) || 0;
        if (tx.type !== "expense") return;
        const category = (tx.category || "").trim();
        if (category === "تحويل لليمن (مصاريف أسرة)") {
          yemenTotal += amount;
        } else if (category === "استثمار") {
          investTotal += amount;
        }
      });

      balanceEl.textContent = formatCurrency(balance);
      yemenEl.textContent = formatCurrency(yemenTotal);
      investEl.textContent = formatCurrency(investTotal);
    }

    
    /* التصنيفات */

    let selectedCategoryId = null;

    function ensureCategoriesState() {
      if (!Array.isArray(state.categories)) {
        state.categories = [];
      }
    }

    function renderCategoryOptions() {
      const select = document.getElementById("tx-category-select");
      if (!select) return;
      ensureCategoriesState();

      const currentValue = select.value;
      select.innerHTML = '<option value="">بدون تصنيف</option>';

      state.categories.forEach(function (cat) {
        const opt = document.createElement("option");
        opt.value = cat.id;
        opt.textContent = cat.name;
        select.appendChild(opt);
      });

      if (currentValue) {
        select.value = currentValue;
      }
    }

    function computeCategoryTotals(cat, fromStr, toStr) {
      let income = 0;
      let expense = 0;
      let count = 0;

      const from = (fromStr || "").trim();
      const to = (toStr || "").trim();

      state.transactions.forEach(function (tx) {
        if (!tx) return;

        const txCatName = (tx.category || "").trim();
        const txCatId = tx.categoryId || null;

        const matchesCategory =
          (txCatId && txCatId === cat.id) ||
          (!txCatId && txCatName && txCatName === (cat.name || "").trim());

        if (!matchesCategory) return;

        const dateStr = (tx.date || "").slice(0, 10);
        if (from && (!dateStr || dateStr < from)) return;
        if (to && (!dateStr || dateStr > to)) return;

        const amount = Number(tx.amount) || 0;
        if (tx.type === "income") income += amount;
        else if (tx.type === "expense") expense += amount;

        count += 1;
      });

      return {
        income: income,
        expense: expense,
        net: income - expense,
        count: count
      };
    }

    function renderCategories() {
      ensureCategoriesState();
      const grid = document.getElementById("categories-grid");
      const emptyMsg = document.getElementById("categories-empty");
      if (!grid || !emptyMsg) return;

      grid.innerHTML = "";

      if (!state.categories.length) {
        emptyMsg.classList.remove("hidden");
        return;
      } else {
        emptyMsg.classList.add("hidden");
      }

      const fromInput = document.getElementById("category-filter-from");
      const toInput = document.getElementById("category-filter-to");
      const fromStr = fromInput ? fromInput.value : "";
      const toStr = toInput ? toInput.value : "";

      state.categories.forEach(function (cat) {
        const totals = computeCategoryTotals(cat, fromStr, toStr);
        const income = totals.income;
        const expense = totals.expense;
        const net = totals.net;
        const count = totals.count;

        const card = document.createElement("div");
        card.className = "stat-card category-card";
        card.dataset.id = cat.id;
        card.setAttribute("draggable", "true");

        if (net > 0) card.classList.add("cat-positive");
        else if (net < 0) card.classList.add("cat-negative");
        else card.classList.add("cat-neutral");

        if (selectedCategoryId === cat.id) {
          card.classList.add("category-selected");
        }

        card.innerHTML = `
          <div class="stat-label">
            <span>${cat.name}</span>
            <span>${count ? "عمليات: " + count : "لا توجد عمليات"}</span>
          </div>
          <div class="stat-value">
            <span>${formatCurrency(net)}</span>
            <span class="currency">ر.س</span>
          </div>
          <div class="stat-footnote">
            دخل: ${formatCurrency(income)} / صرف: ${formatCurrency(expense)}
          </div>
          <div class="category-meta">
            اضغط على البطاقة لعرض العمليات، واسحبها لتغيير الترتيب.
          </div>
          <div class="category-actions">
            <button type="button" class="btn-secondary btn-xs category-edit-btn">تعديل</button>
            <button type="button" class="btn-danger btn-xs category-delete-btn">حذف</button>
          </div>
        `;

        card.addEventListener("click", function (e) {
          if (e.target && (e.target.closest && (e.target.closest(".category-edit-btn") || e.target.closest(".category-delete-btn")))) {
            return;
          }
          selectedCategoryId = cat.id;
          renderCategories();
          renderCategoryTransactions();
        });

        const editBtn = card.querySelector(".category-edit-btn");
        editBtn.addEventListener("click", function () {
          const idInput = document.getElementById("category-id");
          const nameInput = document.getElementById("category-name");
          const submitBtn = document.getElementById("category-submit-btn");
          if (!idInput || !nameInput || !submitBtn) return;
          idInput.value = cat.id;
          nameInput.value = cat.name;
          submitBtn.textContent = "حفظ التعديل";
          nameInput.focus();
        });

        const deleteBtn = card.querySelector(".category-delete-btn");
        deleteBtn.addEventListener("click", function () {
          if (!confirm("حذف هذا التصنيف؟ لن تُحذف العمليات، لكن ستصبح بدون تصنيف.")) {
            return;
          }
          const removedId = cat.id;
          state.categories = state.categories.filter(function (c) {
            return c.id !== removedId;
          });
          state.transactions.forEach(function (tx) {
            if (tx.categoryId === removedId) {
              tx.categoryId = null;
              tx.category = tx.category || "";
            }
          });
          if (selectedCategoryId === removedId) {
            selectedCategoryId = null;
          }
          saveState();
          renderCategories();
          renderCategoryOptions();
          renderCategoryTransactions();
        });

        card.addEventListener("dragstart", function (e) {
          card.classList.add("dragging");
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", cat.id);
        });

        card.addEventListener("dragend", function () {
          card.classList.remove("dragging");
        });

        card.addEventListener("dragover", function (e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });

        card.addEventListener("drop", function (e) {
          e.preventDefault();
          const draggedId = e.dataTransfer.getData("text/plain");
          if (!draggedId || draggedId === cat.id) return;

          const arr = state.categories;
          const fromIndex = arr.findIndex(function (c) {
            return c.id === draggedId;
          });
          const toIndex = arr.findIndex(function (c) {
            return c.id === cat.id;
          });
          if (fromIndex === -1 || toIndex === -1) return;

          const movedArr = arr.splice(fromIndex, 1);
          const moved = movedArr[0];
          arr.splice(toIndex, 0, moved);
          saveState();
          renderCategories();
        });

        grid.appendChild(card);
      });
    }

    function renderCategoryTransactions() {
      const tbody = document.querySelector("#category-transactions-table tbody");
      const label = document.getElementById("category-selected-label");
      if (!tbody || !label) return;

      tbody.innerHTML = "";

      if (!selectedCategoryId) {
        label.textContent =
          "اختر بطاقة تصنيف من الأعلى لعرض العمليات المرتبطة به.";
        return;
      }

      const cat = (state.categories || []).find(function (c) {
        return c.id === selectedCategoryId;
      });
      if (!cat) {
        label.textContent =
          "التصنيف المحدد لم يعد موجوداً. اختر تصنيفاً آخر.";
        selectedCategoryId = null;
        return;
      }

      const fromInput = document.getElementById("category-filter-from");
      const toInput = document.getElementById("category-filter-to");
      const fromStr = fromInput ? fromInput.value : "";
      const toStr = toInput ? toInput.value : "";

      label.textContent =
        "العمليات المرتبطة بتصنيف: " + (cat.name || "");

      const filtered = state.transactions.filter(function (tx) {
        if (!tx) return false;
        const txCatName = (tx.category || "").trim();
        const txCatId = tx.categoryId || null;
        const matchesCategory =
          (txCatId && txCatId === cat.id) ||
          (!txCatId && txCatName && txCatName === (cat.name || "").trim());
        if (!matchesCategory) return false;

        const dateStr = (tx.date || "").slice(0, 10);
        if (fromStr && (!dateStr || dateStr < fromStr)) return false;
        if (toStr && (!dateStr || dateStr > toStr)) return false;

        return true;
      });

      if (!filtered.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.className = "text-muted";
        td.textContent = "لا توجد عمليات مطابقة لهذا التصنيف حسب الفلتر.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      const sorted = filtered.slice().sort(function (a, b) {
        return new Date(b.date) - new Date(a.date);
      });

      sorted.forEach(function (tx) {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = formatDateStr(tx.date);

        const tdType = document.createElement("td");
        const badge = document.createElement("span");
        badge.classList.add("badge");
        if (tx.type === "income") {
          badge.classList.add("badge-success");
          badge.textContent = "دخل";
        } else {
          badge.classList.add("badge-danger");
          badge.textContent = "صرف";
        }
        tdType.appendChild(badge);

        const tdAmount = document.createElement("td");
        tdAmount.textContent = formatCurrency(tx.amount);

        const tdNote = document.createElement("td");
        tdNote.textContent = tx.note || "-";

        tr.appendChild(tdDate);
        tr.appendChild(tdType);
        tr.appendChild(tdAmount);
        tr.appendChild(tdNote);

        tbody.appendChild(tr);
      });
    }

    function setupCategories() {
      ensureCategoriesState();
      const form = document.getElementById("category-form");
      const idInput = document.getElementById("category-id");
      const nameInput = document.getElementById("category-name");
      const submitBtn = document.getElementById("category-submit-btn");
      const filterForm = document.getElementById("category-filter-form");

      if (form) {
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          const name = (nameInput.value || "").trim();
          const id = (idInput.value || "").trim();

          if (!name) {
            alert("أدخل اسم التصنيف.");
            return;
          }

          if (id) {
            const existing = state.categories.find(function (c) {
              return c.id === id;
            });
            if (existing) {
              const oldName = existing.name;
              existing.name = name;

              state.transactions.forEach(function (tx) {
                const catName = (tx.category || "").trim();
                if (tx.categoryId === id || (!tx.categoryId && catName === oldName)) {
                  tx.categoryId = id;
                  tx.category = name;
                }
              });
            }
          } else {
            const newCat = {
              id: generateId(),
              name: name
            };
            state.categories.push(newCat);
          }

          saveState();
          renderCategoryOptions();
          renderCategories();
          renderCategoryTransactions();

          form.reset();
          idInput.value = "";
          submitBtn.textContent = "+ إضافة تصنيف";
        });
      }

      if (filterForm) {
        filterForm.addEventListener("submit", function (e) {
          e.preventDefault();
          renderCategories();
          renderCategoryTransactions();
        });
      }

      renderCategoryOptions();
      renderCategories();
      renderCategoryTransactions();
    }

    function setupTabs() {
      const buttons = document.querySelectorAll(".tab-btn");
      const sections = document.querySelectorAll(".tab-content");

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.dataset.tab;
          buttons.forEach((b) => b.classList.remove("active"));
          sections.forEach((s) => s.classList.remove("active"));
          btn.classList.add("active");
          document.getElementById("tab-" + target).classList.add("active");
        });
      });
    }

    /* Dashboard */
    function renderDashboard() {
      const now = new Date();
      const todayStr = now.toISOString().slice(0, 10);
      const month = now.getMonth();
      const year = now.getFullYear();

      let todayIncome = 0,
        todayExpense = 0,
        monthIncome = 0,
        monthExpense = 0;

      state.transactions.forEach((tx) => {
        const amount = Number(tx.amount) || 0;
        if (!tx.date) return;
        const txDate = new Date(tx.date);
        if (isNaN(txDate)) return;

        const txYear = txDate.getFullYear();
        const txMonth = txDate.getMonth();
        const txDayStr = tx.date.slice(0, 10);

        if (txYear === year && txMonth === month) {
          if (tx.type === "income") monthIncome += amount;
          else monthExpense += amount;
        }

        if (txDayStr === todayStr) {
          if (tx.type === "income") todayIncome += amount;
          else todayExpense += amount;
        }
      });

      document.getElementById("today-expense").textContent =
        formatCurrency(todayExpense);
      document.getElementById("today-income").textContent =
        formatCurrency(todayIncome);
      document.getElementById("month-expense").textContent =
        formatCurrency(monthExpense);
      document.getElementById("month-income").textContent =
        formatCurrency(monthIncome);

      const totalTasks = state.tasks.length;
      const openTasks = state.tasks.filter((t) => t.status !== "done").length;
      document.getElementById("tasks-open-count").textContent = openTasks;
      document.getElementById("tasks-total-count").textContent = totalTasks;

      const totalProjects = state.projects.length;
      const activeProjects = state.projects.filter(
        (p) => p.status === "in-progress" || p.status === "planned"
      ).length;
      document.getElementById("projects-active-count").textContent =
        activeProjects;
      document.getElementById("projects-total-count").textContent =
        totalProjects;

      // تحدّيث ملخص المال (الرصيد + الاستثمار)
      updateMoneySummary();
    }

    /* Money */
    function setupMoney() {
      const form = document.getElementById("transaction-form");
      const dateInput = document.getElementById("tx-date");
      const todayStr = new Date().toISOString().slice(0, 10);
      if (dateInput) {
        dateInput.value = todayStr;
      }

      // تعبئة قائمة التصنيفات عند فتح الصفحة
      renderCategoryOptions();

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const date = (dateInput && dateInput.value) ? dateInput.value : todayStr;
        const type = document.getElementById("tx-type").value;
        const amountInput = document.getElementById("tx-amount");
        const amount = parseFloat(amountInput.value || "0");
        const categorySelect = document.getElementById("tx-category-select");
        const selectedCatId = categorySelect ? categorySelect.value : "";
        const note = document.getElementById("tx-note").value.trim();

        if (!amount || amount <= 0) {
          alert("أدخل مبلغًا صحيحًا.");
          return;
        }

        let categoryName = "";
        if (selectedCatId) {
          const catObj = (state.categories || []).find(function (c) {
            return c.id === selectedCatId;
          });
          if (catObj) {
            categoryName = catObj.name;
          }
        }

        state.transactions.push({
          id: generateId(),
          date: date,
          type: type,
          amount: amount,
          category: categoryName,
          categoryId: selectedCatId || null,
          note: note
        });

        saveState();
        amountInput.value = "";
        if (categorySelect) categorySelect.value = "";
        document.getElementById("tx-note").value = "";
        renderTransactions();
        renderDashboard();
      });

      setupInvestments();
      renderTransactions();
      updateMoneySummary();
    }

    function setupInvestments() {
      const form = document.getElementById("investment-form");
      const dateInput = document.getElementById("inv-date");
      const todayStr = new Date().toISOString().slice(0, 10);
      if (dateInput) {
        dateInput.value = todayStr;
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const date = (dateInput && dateInput.value) ? dateInput.value : todayStr;
        const type = document.getElementById("inv-type").value;
        const amountInput = document.getElementById("inv-amount");
        const amount = parseFloat(amountInput.value || "0");
        const note = document.getElementById("inv-note").value.trim();

        if (!amount || amount <= 0) {
          alert("أدخل مبلغًا صحيحًا.");
          return;
        }

        let categoryName = "";
        if (type === "yemen") {
          categoryName = "تحويل لليمن (مصاريف أسرة)";
        } else if (type === "invest") {
          categoryName = "استثمار";
        }

        let categoryId = null;
        if (categoryName) {
          const catObj = (state.categories || []).find(function (c) {
            return (c.name || "").trim() === categoryName;
          });
          if (catObj) {
            categoryId = catObj.id;
          }
        }

        state.transactions.push({
          id: generateId(),
          date: date,
          type: "expense",
          amount: amount,
          category: categoryName,
          categoryId: categoryId,
          note: note
        });

        saveState();
        amountInput.value = "";
        document.getElementById("inv-note").value = "";
        renderTransactions();
        renderDashboard();
      });
    }


    function renderTransactions() {
      const tbody = document.querySelector("#transactions-table tbody");
      tbody.innerHTML = "";

      if (!state.transactions.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "text-muted";
        td.textContent = "لا توجد عمليات مسجلة بعد.";
        tr.appendChild(td);
        tbody.appendChild(tr);

        // تحديث التصنيفات حتى لو لا توجد عمليات
        renderCategories();
        renderCategoryTransactions();
        return;
      }

      // حساب إجمالي الدخل والصرف
      let totalIncome = 0;
      let totalExpense = 0;

      state.transactions.forEach(function (tx) {
        const amount = Number(tx.amount) || 0;
        if (tx.type === "income") {
          totalIncome += amount;
        } else if (tx.type === "expense") {
          totalExpense += amount;
        }
      });

      const balance = totalIncome - totalExpense;

      // صف الإجماليات في أول الجدول
      const summaryRow = document.createElement("tr");
      summaryRow.classList.add("summary-row");
      summaryRow.innerHTML = `
        <td>الإجماليات</td>
        <td>
          <span class="text-success">دخل: ${formatCurrency(totalIncome)}</span>
          &nbsp;/&nbsp;
          <span class="text-danger">صرف: ${formatCurrency(totalExpense)}</span>
        </td>
        <td>${formatCurrency(balance)}</td>
        <td colspan="3"></td>
      `;
      tbody.appendChild(summaryRow);

      // بعدها العمليات مرتبة بالتاريخ
      const sorted = state.transactions.slice().sort(function (a, b) {
        return new Date(b.date) - new Date(a.date);
      });

      sorted.forEach(function (tx) {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = formatDateStr(tx.date);

        const tdType = document.createElement("td");
        const badge = document.createElement("span");
        badge.classList.add("badge");
        if (tx.type === "income") {
          badge.classList.add("badge-success");
          badge.textContent = "دخل";
        } else {
          badge.classList.add("badge-warning");
          badge.textContent = "صرف";
        }
        tdType.appendChild(badge);

        const tdAmount = document.createElement("td");
        tdAmount.textContent = formatCurrency(tx.amount);

        const tdCat = document.createElement("td");
        tdCat.textContent = tx.category || "-";

        const tdNote = document.createElement("td");
        tdNote.textContent = tx.note || "-";

        const tdActions = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger btn-xs";
        delBtn.textContent = "حذف";
        delBtn.addEventListener("click", function () {
          if (confirm("حذف هذه العملية نهائيًا؟")) {
            state.transactions = state.transactions.filter(function (t) {
              return t.id !== tx.id;
            });
            saveState();
            renderTransactions();
            renderDashboard();
          }
        });
        tdActions.appendChild(delBtn);

        tr.appendChild(tdDate);
        tr.appendChild(tdType);
        tr.appendChild(tdAmount);
        tr.appendChild(tdCat);
        tr.appendChild(tdNote);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });

      // تحديث تبويب التصنيفات بعد أي تغيير في العمليات
      renderCategories();
      renderCategoryTransactions();
    }


    /* Tasks */
    function setupTasks() {
      const form = document.getElementById("task-form");
      const idInput = document.getElementById("task-id");
      const submitBtn = document.getElementById("task-submit-btn");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const id = idInput.value;
        const title = document.getElementById("task-title").value.trim();
        const status = document.getElementById("task-status").value;
        const date = document.getElementById("task-date").value;
        const notes = document.getElementById("task-notes").value.trim();

        if (!title) {
          alert("أدخل عنوان المهمة.");
          return;
        }

        if (id) {
          const existing = state.tasks.find((t) => t.id === id);
          if (existing) {
            existing.title = title;
            existing.status = status;
            existing.date = date;
            existing.notes = notes;
          }
        } else {
          state.tasks.push({
            id: generateId(),
            title,
            status,
            date,
            notes
          });
        }

        saveState();
        form.reset();
        idInput.value = "";
        submitBtn.textContent = "+ إضافة مهمة";
        renderTasks();
        renderDashboard();
      });

      renderTasks();
    }

    function renderTasks() {
      const tbody = document.querySelector("#tasks-table tbody");
      tbody.innerHTML = "";
      if (!state.tasks.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "text-muted";
        td.textContent = "لا توجد مهام مسجلة.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      const statusLabels = {
        "todo": "لم تبدأ",
        "in-progress": "قيد العمل",
        "done": "منتهية"
      };

      const sorted = [...state.tasks].sort((a, b) => {
        const da = a.date || "";
        const db = b.date || "";
        return db.localeCompare(da);
      });

      sorted.forEach((task) => {
        const tr = document.createElement("tr");

        const tdTitle = document.createElement("td");
        tdTitle.textContent = task.title;

        const tdStatus = document.createElement("td");
        const badge = document.createElement("span");
        badge.classList.add("badge");
        if (task.status === "done") badge.classList.add("badge-success");
        else if (task.status === "in-progress")
          badge.classList.add("badge-warning");
        badge.textContent = statusLabels[task.status] || "-";
        tdStatus.appendChild(badge);

        const tdDate = document.createElement("td");
        tdDate.textContent = task.date || "-";

        const tdNotes = document.createElement("td");
        tdNotes.textContent = task.notes || "-";

        const tdActions = document.createElement("td");

        if (task.status !== "done") {
          const completeBtn = document.createElement("button");
          completeBtn.className = "btn-secondary btn-xs";
          completeBtn.textContent = "وضع منتهية";
          completeBtn.addEventListener("click", () => {
            task.status = "done";
            saveState();
            renderTasks();
            renderDashboard();
          });
          tdActions.appendChild(completeBtn);
        }

        const editBtn = document.createElement("button");
        editBtn.className = "btn-secondary btn-xs";
        editBtn.textContent = "تعديل";
        editBtn.style.marginInlineStart = "4px";
        editBtn.addEventListener("click", () => {
          document.getElementById("task-id").value = task.id;
          document.getElementById("task-title").value = task.title;
          document.getElementById("task-status").value = task.status;
          document.getElementById("task-date").value = task.date || "";
          document.getElementById("task-notes").value = task.notes || "";
          document.getElementById("task-submit-btn").textContent =
            "حفظ التعديل";
          document
            .getElementById("task-title")
            .scrollIntoView({ behavior: "smooth", block: "center" });
        });
        tdActions.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger btn-xs";
        delBtn.textContent = "حذف";
        delBtn.style.marginInlineStart = "4px";
        delBtn.addEventListener("click", () => {
          if (confirm("حذف هذه المهمة؟")) {
            state.tasks = state.tasks.filter((t) => t.id !== task.id);
            saveState();
            renderTasks();
            renderDashboard();
          }
        });
        tdActions.appendChild(delBtn);

        tr.appendChild(tdTitle);
        tr.appendChild(tdStatus);
        tr.appendChild(tdDate);
        tr.appendChild(tdNotes);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    /* Assets */
    function setupAssets() {
      const form = document.getElementById("asset-form");
      const archiveWrapper = document.getElementById("archive-wrapper");
      const toggleArchiveBtn = document.getElementById("toggle-archive-btn");

      toggleArchiveBtn.addEventListener("click", () => {
        archiveWrapper.classList.toggle("hidden");
      });

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = document.getElementById("asset-name").value.trim();
        const location = document
          .getElementById("asset-location")
          .value.trim();
        const value = parseFloat(
          document.getElementById("asset-value").value || "0"
        );
        const notes = document.getElementById("asset-notes").value.trim();

        if (!name) {
          alert("أدخل وصف الممتلك.");
          return;
        }

        state.assets.push({
          id: generateId(),
          name,
          location,
          value: isNaN(value) ? 0 : value,
          notes,
          isArchived: false
        });

        saveState();
        form.reset();
        renderAssets();
      });

      renderAssets();
    }

    function renderAssets() {
      const currentBody = document.querySelector(
        "#assets-current-table tbody"
      );
      const archiveBody = document.querySelector(
        "#assets-archive-table tbody"
      );
      currentBody.innerHTML = "";
      archiveBody.innerHTML = "";

      const current = state.assets.filter((a) => !a.isArchived);
      const archived = state.assets.filter((a) => a.isArchived);

      if (!current.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "text-muted";
        td.textContent = "لا توجد ممتلكات حالية مسجلة.";
        tr.appendChild(td);
        currentBody.appendChild(tr);
      } else {
        current.forEach((a) => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = a.name;

          const tdLoc = document.createElement("td");
          tdLoc.textContent = a.location || "-";

          const tdVal = document.createElement("td");
          tdVal.textContent = a.value ? formatCurrency(a.value) : "-";

          const tdNotes = document.createElement("td");
          tdNotes.textContent = a.notes || "-";

          const tdActions = document.createElement("td");

          const archiveBtn = document.createElement("button");
          archiveBtn.className = "btn-secondary btn-xs";
          archiveBtn.textContent = "نقل للأرشيف";
          archiveBtn.addEventListener("click", () => {
            a.isArchived = true;
            saveState();
            renderAssets();
          });
          tdActions.appendChild(archiveBtn);

          const delBtn = document.createElement("button");
          delBtn.className = "btn-danger btn-xs";
          delBtn.textContent = "حذف";
          delBtn.style.marginInlineStart = "4px";
          delBtn.addEventListener("click", () => {
            if (confirm("حذف هذا الممتلك نهائيًا؟")) {
              state.assets = state.assets.filter((x) => x.id !== a.id);
              saveState();
              renderAssets();
            }
          });
          tdActions.appendChild(delBtn);

          tr.appendChild(tdName);
          tr.appendChild(tdLoc);
          tr.appendChild(tdVal);
          tr.appendChild(tdNotes);
          tr.appendChild(tdActions);

          currentBody.appendChild(tr);
        });
      }

      if (!archived.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "text-muted";
        td.textContent = "لا توجد عناصر في الأرشيف.";
        tr.appendChild(td);
        archiveBody.appendChild(tr);
      } else {
        archived.forEach((a) => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.textContent = a.name;

          const tdLoc = document.createElement("td");
          tdLoc.textContent = a.location || "-";

          const tdVal = document.createElement("td");
          tdVal.textContent = a.value ? formatCurrency(a.value) : "-";

          const tdNotes = document.createElement("td");
          tdNotes.textContent = a.notes || "-";

          const tdActions = document.createElement("td");

          const restoreBtn = document.createElement("button");
          restoreBtn.className = "btn-secondary btn-xs";
          restoreBtn.textContent = "استعادة";
          restoreBtn.addEventListener("click", () => {
            a.isArchived = false;
            saveState();
            renderAssets();
          });
          tdActions.appendChild(restoreBtn);

          const delBtn = document.createElement("button");
          delBtn.className = "btn-danger btn-xs";
          delBtn.textContent = "حذف";
          delBtn.style.marginInlineStart = "4px";
          delBtn.addEventListener("click", () => {
            if (confirm("حذف هذا العنصر من الأرشيف؟")) {
              state.assets = state.assets.filter((x) => x.id !== a.id);
              saveState();
              renderAssets();
            }
          });
          tdActions.appendChild(delBtn);

          tr.appendChild(tdName);
          tr.appendChild(tdLoc);
          tr.appendChild(tdVal);
          tr.appendChild(tdNotes);
          tr.appendChild(tdActions);

          archiveBody.appendChild(tr);
        });
      }
    }

    /* Projects */
    function setupProjects() {
      const form = document.getElementById("project-form");
      const idInput = document.getElementById("project-id");
      const submitBtn = document.getElementById("project-submit-btn");
      const progressInput = document.getElementById("project-progress");
      const progressLabel = document.getElementById(
        "project-progress-label"
      );

      progressInput.addEventListener("input", () => {
        progressLabel.textContent = progressInput.value + "%";
      });

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const id = idInput.value;
        const name = document.getElementById("project-name").value.trim();
        const client = document
          .getElementById("project-client")
          .value.trim();
        const status = document.getElementById("project-status").value;
        const progress = parseInt(
          document.getElementById("project-progress").value || "0",
          10
        );
        const notes = document
          .getElementById("project-notes")
          .value.trim();

        if (!name) {
          alert("أدخل اسم المشروع.");
          return;
        }

        if (id) {
          const existing = state.projects.find((p) => p.id === id);
          if (existing) {
            existing.name = name;
            existing.client = client;
            existing.status = status;
            existing.progress = progress;
            existing.notes = notes;
          }
        } else {
          state.projects.push({
            id: generateId(),
            name,
            client,
            status,
            progress,
            notes
          });
        }

        saveState();
        form.reset();
        idInput.value = "";
        submitBtn.textContent = "+ إضافة مشروع";
        progressInput.value = 0;
        progressLabel.textContent = "0%";
        renderProjects();
        renderDashboard();
      });

      renderProjects();
    }

    function renderProjects() {
      const tbody = document.querySelector("#projects-table tbody");
      tbody.innerHTML = "";

      if (!state.projects.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "text-muted";
        td.textContent = "لا توجد مشاريع مسجلة.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      const statusLabels = {
        "planned": "مخطط",
        "in-progress": "قيد التنفيذ",
        "on-hold": "معلّق",
        "done": "مكتمل"
      };

      const sorted = [...state.projects].sort((a, b) => {
        return (b.progress || 0) - (a.progress || 0);
      });

      sorted.forEach((p) => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = p.name;

        const tdClient = document.createElement("td");
        tdClient.textContent = p.client || "-";

        const tdStatus = document.createElement("td");
        const badge = document.createElement("span");
        badge.classList.add("badge");
        if (p.status === "done") badge.classList.add("badge-success");
        else if (p.status === "on-hold")
          badge.classList.add("badge-warning");
        badge.textContent = statusLabels[p.status] || "-";
        tdStatus.appendChild(badge);

        const tdProgress = document.createElement("td");
        const bar = document.createElement("div");
        bar.className = "progress-bar";
        const fill = document.createElement("div");
        fill.className = "progress-bar-fill";
        fill.style.width = (p.progress || 0) + "%";
        bar.appendChild(fill);
        const text = document.createElement("div");
        text.className = "progress-text";
        text.textContent = (p.progress || 0) + "%";
        tdProgress.appendChild(bar);
        tdProgress.appendChild(text);

        const tdNotes = document.createElement("td");
        tdNotes.textContent = p.notes || "-";

        const tdActions = document.createElement("td");

        const editBtn = document.createElement("button");
        editBtn.className = "btn-secondary btn-xs";
        editBtn.textContent = "تعديل";
        editBtn.addEventListener("click", () => {
          document.getElementById("project-id").value = p.id;
          document.getElementById("project-name").value = p.name;
          document.getElementById("project-client").value = p.client || "";
          document.getElementById("project-status").value = p.status;
          document.getElementById("project-progress").value =
            p.progress || 0;
          document.getElementById("project-progress-label").textContent =
            (p.progress || 0) + "%";
          document.getElementById("project-notes").value = p.notes || "";
          document.getElementById("project-submit-btn").textContent =
            "حفظ التعديل";
          document
            .getElementById("project-name")
            .scrollIntoView({ behavior: "smooth", block: "center" });
        });
        tdActions.appendChild(editBtn);

        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger btn-xs";
        delBtn.textContent = "حذف";
        delBtn.style.marginInlineStart = "4px";
        delBtn.addEventListener("click", () => {
          if (confirm("حذف هذا المشروع؟")) {
            state.projects = state.projects.filter((x) => x.id !== p.id);
            saveState();
            renderProjects();
            renderDashboard();
          }
        });
        tdActions.appendChild(delBtn);

        tr.appendChild(tdName);
        tr.appendChild(tdClient);
        tr.appendChild(tdStatus);
        tr.appendChild(tdProgress);
        tr.appendChild(tdNotes);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    /* Wishlist */
    function setupWishlist() {
      const form = document.getElementById("wishlist-form");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const item = document.getElementById("wish-item").value.trim();
        const category = document
          .getElementById("wish-category")
          .value.trim();
        const price = parseFloat(
          document.getElementById("wish-price").value || "0"
        );
        const priority = document.getElementById("wish-priority").value;
        const date = document.getElementById("wish-date").value;
        const notes = document.getElementById("wish-notes").value.trim();

        if (!item) {
          alert("أدخل اسم العنصر.");
          return;
        }

        state.futurePurchases.push({
          id: generateId(),
          item,
          category,
          price: isNaN(price) ? 0 : price,
          priority,
          date,
          notes,
          status: "planned"
        });

        saveState();
        form.reset();
        renderWishlist();
      });

      renderWishlist();
    }

    function renderWishlist() {
      const tbody = document.querySelector("#wishlist-table tbody");
      tbody.innerHTML = "";

      if (!state.futurePurchases.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.className = "text-muted";
        td.textContent = "لا توجد مشتريات مستقبلية مسجلة.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      const priorityLabels = {
        "low": "منخفضة",
        "medium": "متوسطة",
        "high": "عالية"
      };

      const sorted = [...state.futurePurchases].sort((a, b) => {
        const prioWeight = { high: 3, medium: 2, low: 1 };
        return (
          (prioWeight[b.priority] || 0) - (prioWeight[a.priority] || 0)
        );
      });

      sorted.forEach((w) => {
        const tr = document.createElement("tr");

        const tdItem = document.createElement("td");
        tdItem.textContent = w.item;

        const tdCat = document.createElement("td");
        tdCat.textContent = w.category || "-";

        const tdPrice = document.createElement("td");
        tdPrice.textContent = w.price ? formatCurrency(w.price) : "-";

        const tdPriority = document.createElement("td");
        const badge = document.createElement("span");
        badge.classList.add("badge");
        if (w.priority === "high") badge.classList.add("badge-danger");
        badge.textContent = priorityLabels[w.priority] || "-";
        tdPriority.appendChild(badge);

        const tdDate = document.createElement("td");
        tdDate.textContent = w.date || "-";

        const tdNotes = document.createElement("td");
        tdNotes.textContent = w.notes || "-";

        const tdActions = document.createElement("td");
        const toggleBtn = document.createElement("button");
        toggleBtn.className = "btn-secondary btn-xs";
        toggleBtn.textContent =
          w.status === "bought" ? "إرجاع كـ مخطط" : "تم الشراء";
        toggleBtn.addEventListener("click", () => {
          w.status = w.status === "bought" ? "planned" : "bought";
          saveState();
          renderWishlist();
        });
        tdActions.appendChild(toggleBtn);

        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger btn-xs";
        delBtn.textContent = "حذف";
        delBtn.style.marginInlineStart = "4px";
        delBtn.addEventListener("click", () => {
          if (confirm("حذف هذا العنصر من القائمة؟")) {
            state.futurePurchases = state.futurePurchases.filter(
              (x) => x.id !== w.id
            );
            saveState();
            renderWishlist();
          }
        });
        tdActions.appendChild(delBtn);

        if (w.status === "bought") {
          tr.style.opacity = "0.7";
        }

        tr.appendChild(tdItem);
        tr.appendChild(tdCat);
        tr.appendChild(tdPrice);
        tr.appendChild(tdPriority);
        tr.appendChild(tdDate);
        tr.appendChild(tdNotes);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    /* Clients */
    function setupClients() {
      const form = document.getElementById("client-form");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = document.getElementById("client-name").value.trim();
        const phone = document
          .getElementById("client-phone")
          .value.trim();
        const company = document
          .getElementById("client-company")
          .value.trim();
        const work = document
          .getElementById("client-work")
          .value.trim();
        const notes = document
          .getElementById("client-notes")
          .value.trim();

        if (!name) {
          alert("أدخل اسم العميل.");
          return;
        }

        state.clients.push({
          id: generateId(),
          name,
          phone,
          company,
          work,
          notes
        });

        saveState();
        form.reset();
        renderClients();
      });

      renderClients();
    }

    function renderClients() {
      const tbody = document.querySelector("#clients-table tbody");
      tbody.innerHTML = "";

      if (!state.clients.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "text-muted";
        td.textContent = "لا توجد بيانات عملاء حتى الآن.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      const sorted = [...state.clients].sort((a, b) =>
        (a.name || "").localeCompare(b.name || "", "ar")
      );

      sorted.forEach((c) => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = c.name;

        const tdPhone = document.createElement("td");
        tdPhone.textContent = c.phone || "-";

        const tdCompany = document.createElement("td");
        tdCompany.textContent = c.company || "-";

        const tdWork = document.createElement("td");
        tdWork.textContent = c.work || "-";

        const tdNotes = document.createElement("td");
        tdNotes.textContent = c.notes || "-";

        const tdActions = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.className = "btn-danger btn-xs";
        delBtn.textContent = "حذف";
        delBtn.addEventListener("click", () => {
          if (confirm("حذف هذا العميل من القاعدة؟")) {
            state.clients = state.clients.filter((x) => x.id !== c.id);
            saveState();
            renderClients();
          }
        });
        tdActions.appendChild(delBtn);

        tr.appendChild(tdName);
        tr.appendChild(tdPhone);
        tr.appendChild(tdCompany);
        tr.appendChild(tdWork);
        tr.appendChild(tdNotes);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadState();
      setupTabs();
      setupCategories();
      setupMoney();
      setupTasks();
      setupAssets();
      setupProjects();
      setupWishlist();
      setupClients();
      renderDashboard();

      const syncRemoteBtn = document.getElementById("sync-remote-btn");
      const importBtn = document.getElementById("import-btn");
      const exportBtn = document.getElementById("export-btn");
      const importFile = document.getElementById("import-file");

      if (importBtn && importFile) {
        importBtn.addEventListener("click", async () => {
          if (supportsFileSystemAccess()) {
            await importFromDbFile();
          } else {
            importFile.click();
          }
        });

        importFile.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (file) {
            importFromFile(file);
          }
          e.target.value = "";
        });
      }

      if (syncRemoteBtn) {
        syncRemoteBtn.addEventListener("click", function () {
          syncFromRemote(true);
        });
      }

      if (exportBtn) {
        exportBtn.addEventListener("click", async () => {
          if (supportsFileSystemAccess()) {
            await exportToDbFile();
          } else {
            exportToFile();
          }
        });
      }

      // محاولة الاستيراد تلقائياً من ملف قاعدة البيانات المخزن (إن وجد)
      (async () => {
        await tryAutoImportFromDbFileOnLoad();
      })();
    });

  </script>
</body>
</html>
